<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hunger Groomers - Redirecting</title>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            background-color: #f9f9f9;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            text-align: center;
        }
        .container {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            padding: 30px;
            max-width: 500px;
            width: 90%;
        }
        h1 {
            color: #4285F4;
            margin-bottom: 20px;
        }
        #loadingDiv {
            margin: 20px 0;
        }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-radius: 50%;
            border-top: 4px solid #4285F4;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        #contentDiv {
            margin-bottom: 20px;
        }
        #errorDiv {
            color: #d32f2f;
            padding: 10px;
            border-radius: 4px;
            background-color: #ffebee;
            margin: 20px 0;
            display: none;
        }
        .btn {
            background-color: #4285F4;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
        }
        .btn:hover {
            background-color: #3367d6;
        }
        #retryBtn {
            background-color: #757575;
            display: none;
        }
        #debug {
            font-size: 10px;
            color: #9e9e9e;
            margin-top: 20px;
            text-align: left;
            max-height: 100px;
            overflow: auto;
            padding: 5px;
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Hunger Groomers</h1>
        
        <div id="contentDiv">
            <p>Please wait while we prepare your location sharing page...</p>
            <button id="continueBtn" class="btn" onclick="performRedirect()">Continue</button>
        </div>
        
        <div id="loadingDiv" style="display: none;">
            <div class="spinner"></div>
            <p id="loadingStatusDiv">Preparing your page...</p>
        </div>
        
        <div id="errorDiv">
            <p id="errorText">Something went wrong. Please try again.</p>
        </div>
        
        <button id="retryBtn" class="btn" onclick="performRedirect()">Try Again</button>
    </div>
    
    <div id="debug"></div>
    
    <script>
        // Configure these values - should match your Apps Script settings
        const webAppUrl = "https://script.google.com/macros/s/AKfycbykwlRpgMFJ37M7snUphx4n6_HbB_CW-tSU0E3sn0WJtMWFIOX-N8IajymLIHMsJtE1/exec";
        
        // Debug mode for development
        const isDebugMode = false;
        
        // DOM elements
        const loadingDiv = document.getElementById('loadingDiv');
        const contentDiv = document.getElementById('contentDiv');
        const errorDiv = document.getElementById('errorDiv');
        const errorText = document.getElementById('errorText');
        const retryBtn = document.getElementById('retryBtn');
        const loadingStatusDiv = document.getElementById('loadingStatusDiv');
        const debugDiv = document.getElementById('debug');
        
        // Show debug panel if in debug mode
        if (isDebugMode) {
            debugDiv.style.display = 'block';
        }
        
        // Log function that writes to debug div in debug mode
        function log(message) {
            if (isDebugMode) {
                const timestamp = new Date().toLocaleTimeString();
                debugDiv.innerHTML += `[${timestamp}] ${message}<br>`;
                debugDiv.scrollTop = debugDiv.scrollHeight;
                console.log(message);
            }
        }
        
        // Error display function
        function showError(message) {
            loadingDiv.style.display = 'none';
            errorDiv.style.display = 'block';
            errorText.textContent = message;
            retryBtn.style.display = 'block';
            log(`ERROR: ${message}`);
        }
        
        // Get clean parameter value, handling URL encoding issues
        function getParameterValue(paramName) {
            const urlParams = new URLSearchParams(window.location.search);
            const value = urlParams.get(paramName);
            
            if (value) {
                log(`Found raw ${paramName} parameter: ${value}`);
                return value;
            }
            
            log(`No ${paramName} parameter found`);
            return null;
        }
        
        // Get a clean ID parameter - handles potential encoding issues
        function getCleanIdParameter() {
            let id = getParameterValue('id');
            
            // If no id found, try using row parameter as fallback
            if (!id) {
                const row = getParameterValue('row');
                if (row && !isNaN(parseInt(row, 10))) {
                    log(`Using row=${row} as fallback parameter`);
                    return row; // Just pass the row number directly
                }
                return null;
            }
            
            // Log the original ID for debugging
            log(`Original ID value: ${id}`);
            
            // Sanitize id parameter - handle potential double encoding issues
            try {
                // Check if the ID appears to be URI encoded multiple times
                let decodedId = id;
                let decodingAttempts = 0;
                
                // Track each decoding iteration
                while (decodedId.includes('%') && decodingAttempts < 5) {
                    const previousValue = decodedId;
                    try {
                        decodedId = decodeURIComponent(decodedId);
                        log(`Decoded ID iteration ${decodingAttempts+1}: ${decodedId}`);
                        
                        // If decoding didn't change anything, stop trying
                        if (previousValue === decodedId) break;
                        
                        decodingAttempts++;
                    } catch (e) {
                        log(`Decoding error: ${e.message}`);
                        break;
                    }
                }
                
                // Make sure we don't have any unwanted quotes
                decodedId = decodedId.trim();
                if ((decodedId.startsWith('"') && decodedId.endsWith('"')) || 
                    (decodedId.startsWith("'") && decodedId.endsWith("'"))) {
                    decodedId = decodedId.substring(1, decodedId.length - 1);
                    log(`Removed quotes from ID: ${decodedId}`);
                }
                
                log(`Final cleaned ID: ${decodedId}`);
                return decodedId;
            } catch (e) {
                log(`Error sanitizing ID parameter: ${e.message}`);
                return id; // Return the original if we can't sanitize
            }
        }
        
        // Main redirect function
        function performRedirect() {
            // Hide content, show loading
            contentDiv.style.display = 'none';
            loadingDiv.style.display = 'block';
            retryBtn.style.display = 'none';
            errorDiv.style.display = 'none';
            
            // Get the clean ID parameter
            const cleanId = getCleanIdParameter();
            
            if (!cleanId) {
                showError('Missing or invalid ID parameter. This link may have expired.');
                log("ERROR: No valid ID parameter found");
                return;
            }
            
            // Save to sessionStorage as backup
            sessionStorage.setItem('lastid', cleanId);
            
            // Build the target URL - properly encode the ID for URL usage
            const encodedId = encodeURIComponent(cleanId);
            const targetUrl = `${webAppUrl}?id=${encodedId}`;
            
            log(`Final ID being passed: ${cleanId}`);
            log(`Encoded ID for URL: ${encodedId}`);
            log(`Redirecting to: ${targetUrl}`);
            loadingStatusDiv.textContent = 'Redirecting to your dashboard...';
            
            // Verify URL format before redirecting
            try {
                new URL(targetUrl);
            } catch (e) {
                showError(`Invalid URL format: ${e.message}`);
                log(`ERROR: Invalid URL format: ${e.message}`);
                return;
            }
            
            // Perform the redirect after a short delay
            setTimeout(() => {
                try {
                    window.location.href = targetUrl;
                } catch (e) {
                    showError(`Redirect failed: ${e.message}`);
                    log(`ERROR: Redirect failed: ${e.message}`);
                }
            }, 1000);
        }
        
        // Auto-start redirect if in auto mode
        const autoMode = getParameterValue('auto');
        if (autoMode === 'true') {
            log("Auto mode detected, performing redirect automatically");
            document.addEventListener('DOMContentLoaded', performRedirect);
        }
    </script>
</body>
</html>
