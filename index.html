<!DOCTYPE html>
<html>
<head>
  <title>Redirecting to Dashboard...</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta charset="UTF-8">
  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      padding: 20px;
      line-height: 1.5;
      background-color: #f9f9f9;
    }
    #contentDiv {
      max-width: 600px;
      margin: 0 auto;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      background-color: white;
    }
    #loadingDiv {
      display: none;
      margin: 30px auto;
    }
    .loader {
      border: 5px solid #f3f3f3;
      border-top: 5px solid #4285F4;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 2s linear infinite;
      margin: 0 auto;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    #errorDiv {
      display: none;
      color: #d93025;
      margin: 20px auto;
      padding: 15px;
      border: 1px solid #fadde1;
      background-color: #feeef0;
      border-radius: 4px;
    }
    button {
      background: #4285F4;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 4px;
      font-size: 16px;
      cursor: pointer;
      margin: 15px 0;
      transition: background 0.3s;
    }
    button:hover {
      background: #3367d6;
    }
    #debugInfo {
      font-size: 12px;
      color: #666;
      margin-top: 20px;
      text-align: left;
      border: 1px solid #eee;
      padding: 10px;
      border-radius: 4px;
      background-color: #f9f9f9;
      max-height: 200px;
      overflow-y: auto;
      display: none;
    }
    .debug-title {
      font-weight: bold;
      margin-bottom: 5px;
    }
    .debug-btn {
      background: #f1f1f1;
      color: #333;
      font-size: 12px;
      padding: 5px 10px;
      margin-top: 10px;
    }
    .progress-bar {
      height: 4px;
      width: 100%;
      background-color: #e0e0e0;
      margin: 20px 0;
      position: relative;
      overflow: hidden;
    }
    .progress-bar::after {
      content: '';
      position: absolute;
      height: 100%;
      width: 50%;
      background-color: #4285F4;
      animation: indeterminateAnimation 1.5s infinite linear;
      transform-origin: 0% 50%;
    }
    @keyframes indeterminateAnimation {
      0% {
        transform:  translateX(0) scaleX(0);
      }
      40% {
        transform:  translateX(0) scaleX(0.4);
      }
      100% {
        transform:  translateX(100%) scaleX(0.5);
      }
    }
    .success-icon {
      color: #34A853;
      font-size: 48px;
      margin: 20px 0;
    }
    a {
      color: #4285F4;
      text-decoration: none;
    }
    a:hover {
      text-decoration: underline;
    }
    .direct-link {
      margin-top: 20px;
      padding: 10px;
      background: #f5f5f5;
      border-radius: 4px;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <div id="contentDiv">
    <h2>Hunger Groomers Location Sharing</h2>
    <p>We need your location to find nearby tiffin centers.</p>
    <div class="progress-bar"></div>
    <p>Click the button below to continue.</p>
    <button onclick="performRedirect()">Share My Location</button>
    
    <!-- Added direct link option -->
    <div class="direct-link">
      <p>If the automatic redirect doesn't work, <a href="#" id="directLinkAnchor">click here</a> to open directly.</p>
    </div>
    
    <div>
      <button onclick="toggleDebug()" class="debug-btn">Toggle Debug Info</button>
    </div>
    <div id="debugInfo"></div>
  </div>
  
  <div id="loadingDiv">
    <div class="loader"></div>
    <p id="loadingStatusDiv">Processing your request...</p>
  </div>
  
  <div id="errorDiv">
    <h3>Oops! Something went wrong</h3>
    <p id="errorMessage">There was a problem processing your request.</p>
    <div id="errorDetails" style="font-size: 14px; margin: 15px 0; text-align: left; background: #f9f9f9; padding: 10px; border-radius: 4px;"></div>
    <button id="retryBtn" onclick="performRedirect()">Try Again</button>
    <button id="manualRedirectBtn" onclick="showManualRedirect()" style="background: #f1f1f1; color: #333;">Try Manual Redirect</button>
    <div id="manualRedirectDiv" style="display: none; margin-top: 20px; text-align: left;">
      <p>Copy this URL and open it in your browser:</p>
      <input type="text" id="manualRedirectUrl" style="width: 100%; padding: 8px; margin: 5px 0; box-sizing: border-box;" readonly>
      <button onclick="copyManualUrl()" style="background: #34A853; margin-top: 5px;">Copy URL</button>
    </div>
    <p>If the problem persists, please contact support.</p>
  </div>

  <script>
    // Set your web app URL here (must match exactly with Apps Script)
    const webAppUrl = "https://script.google.com/macros/s/AKfycbyrwKtGzOtajxdhBki1kNCZmoWeBKAp_Per7Cl-DdFV1XpXOmeWZDbhU_OxD0u7_zCx/exec";
    
    // Debug mode - set to true for troubleshooting
    const DEBUG_MODE = true;
    
    // Element references
    const contentDiv = document.getElementById('contentDiv');
    const loadingDiv = document.getElementById('loadingDiv');
    const errorDiv = document.getElementById('errorDiv');
    const loadingStatusDiv = document.getElementById('loadingStatusDiv');
    const debugInfoDiv = document.getElementById('debugInfo');
    const errorDetailsDiv = document.getElementById('errorDetails');
    const errorMessageElem = document.getElementById('errorMessage');
    const directLinkAnchor = document.getElementById('directLinkAnchor');
    const manualRedirectUrlInput = document.getElementById('manualRedirectUrl');
    
    // Function to toggle debug info display
    function toggleDebug() {
      if (debugInfoDiv.style.display === 'block') {
        debugInfoDiv.style.display = 'none';
      } else {
        debugInfoDiv.style.display = 'block';
      }
    }
    
    // Function to log if debug mode is on
    function log(message, type = 'info') {
      const timestamp = new Date().toISOString();
      const formattedMessage = `[${timestamp}] ${message}`;
      
      console.log(formattedMessage);
      
      // Also show in the UI for easy debugging
      const className = type === 'error' ? 'color:red;' : type === 'success' ? 'color:green;' : '';
      debugInfoDiv.innerHTML += `<div style="${className}">${formattedMessage}</div>`;
    }
    
    // Function to show errors
    function showError(message, details = '') {
      errorDiv.style.display = 'block';
      contentDiv.style.display = 'none';
      loadingDiv.style.display = 'none';
      
      errorMessageElem.textContent = message;
      errorDetailsDiv.innerHTML = details ? `<strong>Technical details:</strong><br>${details}` : '';
      
      log(`Error: ${message}`, 'error');
      if (details) {
        log(`Error details: ${details}`, 'error');
      }
    }
    
    // Function to show the manual redirect option
    function showManualRedirect() {
      const manualRedirectDiv = document.getElementById('manualRedirectDiv');
      manualRedirectDiv.style.display = 'block';
      
      // Create the manual URL with current parameters
      let redirectUrl = buildRedirectUrl();
      manualRedirectUrlInput.value = redirectUrl;
    }
    
    // Function to copy the manual URL to clipboard
    function copyManualUrl() {
      manualRedirectUrlInput.select();
      document.execCommand('copy');
      
      // Show feedback
      const copyBtn = document.querySelector('#manualRedirectDiv button');
      const originalText = copyBtn.textContent;
      copyBtn.textContent = 'Copied!';
      setTimeout(() => {
        copyBtn.textContent = originalText;
      }, 2000);
    }
    
    // IMPROVED: Robust ID parameter extraction
    function getIdParameter() {
      // Try multiple approaches to get the ID parameter
      const urlParams = new URLSearchParams(window.location.search);
      
      // First check the raw query string - most reliable method
      let id = null;
      const rawQuery = window.location.search;
      const idMatches = rawQuery.match(/[?&]id=([^&]+)/i);
      
      if (idMatches && idMatches[1]) {
        id = idMatches[1];
        log(`Found ID in raw query string: ${id.substring(0, 6)}...`);
        return id; // Return the raw ID without any manipulation
      }
      
      // Second try direct parameter access
      id = urlParams.get('id');
      if (id) {
        log(`Found ID via URLSearchParams: ${id.substring(0, 6)}...`);
        return id;
      }
      
      // Third approach: manual parsing (fallback)
      if (!id) {
        const rawQuery = window.location.search.substring(1);
        const params = rawQuery.split('&');
        for (const param of params) {
          // Case insensitive check for 'id='
          if (param.toLowerCase().startsWith('id=')) {
            id = param.substring(param.indexOf('=') + 1);
            log(`Found ID via manual parsing: ${id.substring(0, 6)}...`);
            break;
          }
        }
      }
      
      if (!id) {
        log('No ID parameter found in URL', 'error');
        return null;
      }
      
      // Important: Do not decode the ID here, pass it exactly as received
      return id;
    }
    
    // IMPROVED: More robust redirect URL building
    function buildRedirectUrl() {
      const url = new URL(webAppUrl);
      
      // Get the raw ID without modifications
      const id = getIdParameter();
      if (id) {
        // CRITICAL: Do not manipulate the ID at all, add it exactly as-is
        url.searchParams.append('id', id);
        log(`Adding raw ID parameter to redirect URL (first ${id.substring(0, 6)}...)`);
        
        // NEW: Also add a parameter to indicate this came through the redirect page
        url.searchParams.append('source', 'redirect_page');
      }
      
      // Add location parameters if available
      if (window.currentPosition) {
        url.searchParams.append('lat', window.currentPosition.coords.latitude);
        url.searchParams.append('lng', window.currentPosition.coords.longitude);
        url.searchParams.append('acc', window.currentPosition.coords.accuracy);
        url.searchParams.append('autostart', 'true'); // Auto-start the location request
      }
      
      // Add timestamp to prevent caching
      url.searchParams.append('t', new Date().getTime());
      
      return url.toString();
    }
    
    // IMPROVED: Enhanced fetch with better error handling
    function sendLocationData(redirectUrl) {
      log('Sending location data via fetch...');
      
      return fetch(redirectUrl, {
        method: 'GET',
        cache: 'no-cache',
        redirect: 'follow',
        headers: {
          'Accept': 'text/html',
          'Cache-Control': 'no-cache'
        }
      })
      .then(response => {
        if (response.ok) {
          log('Location data sent successfully!', 'success');
          return true;
        } else {
          log(`Server responded with status: ${response.status} - ${response.statusText}`, 'error');
          return false;
        }
      })
      .catch(error => {
        log(`Fetch error: ${error.message}`, 'error');
        
        // NEW: Return more details about the fetch failure
        return {
          success: false,
          error: error.message,
          type: 'network'
        };
      });
    }
    
    // IMPROVED: More robust redirect with multiple fallbacks
    function performRedirect() {
      log('Starting redirect process...');
      
      // First verify we have an ID parameter
      const id = getIdParameter();
      if (!id) {
        showError('Missing required ID parameter. The link appears to be invalid or incomplete.', 
                 'URL parameters: ' + window.location.search);
        return;
      }
      
      // Hide content and show loading spinner
      contentDiv.style.display = 'none';
      errorDiv.style.display = 'none';
      loadingDiv.style.display = 'block';
      loadingStatusDiv.textContent = 'Getting your location...';
      
      // Check if geolocation is available
      if (!navigator.geolocation) {
        showError('Geolocation is not supported by your browser. Please use a modern browser that supports location services.');
        return;
      }
      
      // NEW: Track retry attempts for geolocation
      if (!window.geoAttempts) {
        window.geoAttempts = 0;
      }
      
      // Try to get the user's position
      navigator.geolocation.getCurrentPosition(
        // Success callback
        function(position) {
          log(`Successfully got location. Lat: ${position.coords.latitude}, Lng: ${position.coords.longitude}, Acc: ${position.coords.accuracy}m`, 'success');
          loadingStatusDiv.textContent = 'Location acquired. Sending data...';
          
          // Store the position for potential use in manual redirect
          window.currentPosition = position;
          
          // Build the URL with the position data
          let redirectUrl = buildRedirectUrl();
          
          // Update the direct link anchor
          directLinkAnchor.href = redirectUrl;
          
          // IMPROVED: Use multiple transmission methods with fallbacks
          let transmissionStarted = false;
          
          // Method 1: First try to send the data using fetch
          sendLocationData(redirectUrl).then(result => {
            if (result === true) {
              loadingStatusDiv.textContent = 'Location sent successfully! Redirecting...';
              
              // After successful fetch, redirect to the app
              setTimeout(() => {
                log('Redirecting after successful fetch');
                window.location.href = redirectUrl;
              }, 1000);
              transmissionStarted = true;
            } 
            else {
              // If fetch fails, use direct form submission as Method 2
              if (!transmissionStarted) {
                loadingStatusDiv.textContent = 'Using alternative method...';
                log('Trying form submission as fallback');
                
                // Create and submit a form
                const form = document.createElement('form');
                form.method = 'GET';
                form.action = webAppUrl;
                form.style.display = 'none';
                
                // Add ID parameter without encoding
                const idInput = document.createElement('input');
                idInput.type = 'hidden';
                idInput.name = 'id';
                idInput.value = id;
                form.appendChild(idInput);
                
                // Add location parameters
                const latInput = document.createElement('input');
                latInput.type = 'hidden';
                latInput.name = 'lat';
                latInput.value = position.coords.latitude;
                form.appendChild(latInput);
                
                const lngInput = document.createElement('input');
                lngInput.type = 'hidden';
                lngInput.name = 'lng';
                lngInput.value = position.coords.longitude;
                form.appendChild(lngInput);
                
                const accInput = document.createElement('input');
                accInput.type = 'hidden';
                accInput.name = 'acc';
                accInput.value = position.coords.accuracy;
                form.appendChild(accInput);
                
                // Add form to body and submit
                document.body.appendChild(form);
                
                setTimeout(() => {
                  log('Submitting form as fallback');
                  form.submit();
                }, 500);
                transmissionStarted = true;
              }
            }
            
            // Method 3: Ultimate fallback - direct redirect
            if (!transmissionStarted) {
              loadingStatusDiv.textContent = 'Using direct redirect...';
              log('Using direct redirect as final fallback');
              
              setTimeout(() => {
                window.location.href = redirectUrl;
              }, 1000);
            }
          });
        },
        // Error callback - IMPROVED with more detailed error handling
        function(error) {
          window.geoAttempts++;
          
          let errorMsg = '';
          let detailsMsg = '';
          let shouldRetry = false;
          
          switch(error.code) {
            case error.PERMISSION_DENIED:
              errorMsg = 'Location permission was denied. Please allow access to your location and try again.';
              detailsMsg = 'To fix this, please: (1) Check your browser permission settings, (2) Make sure location services are enabled on your device, (3) Try using a different browser if available.';
              break;
            case error.POSITION_UNAVAILABLE:
              errorMsg = 'Location information is unavailable. Please check your device settings.';
              shouldRetry = window.geoAttempts < 3;
              break;
            case error.TIMEOUT:
              errorMsg = 'The request to get your location timed out. Please try again.';
              shouldRetry = window.geoAttempts < 3;
              break;
            default:
              errorMsg = 'An unknown error occurred while trying to get your location.';
              shouldRetry = window.geoAttempts < 2;
          }
          
          log(`Geolocation error (attempt ${window.geoAttempts}): Code ${error.code}, Message: ${error.message}`, 'error');
          
          // Auto-retry for certain error types
          if (shouldRetry) {
            log(`Auto-retrying geolocation (attempt ${window.geoAttempts})`);
            loadingStatusDiv.textContent = `Retrying to get your location (attempt ${window.geoAttempts})...`;
            
            // Wait a moment before retrying
            setTimeout(performRedirect, 2000);
          } else {
            showError(errorMsg, detailsMsg || `Error code: ${error.code}, Message: ${error.message}`);
          }
        },
        // Options - IMPROVED with more reasonable timeouts
        {
          enableHighAccuracy: true,
          timeout: 15000, // Increased timeout
          maximumAge: 0
        }
      );
    }
    
    // IMPROVED: Enhanced initialization function
    function initialize() {
      log('Page initialized', 'info');
      
      // Log user agent for debugging
      log(`User agent: ${navigator.userAgent}`);
      
      // Check if we have required parameters
      const id = getIdParameter();
      if (!id) {
        showError('Missing required ID parameter. The link appears to be invalid or incomplete.');
        return;
      }
      log(`Valid ID parameter found: ${id.substring(0, 6)}...`);
      
      // Set up the direct link with proper event handling
      directLinkAnchor.href = buildRedirectUrl();
      directLinkAnchor.addEventListener('click', function(e) {
        e.preventDefault();
        log('Direct link clicked');
        performRedirect();
      });
      
      // Check for URL parameters that might indicate we should auto-start
      const urlParams = new URLSearchParams(window.location.search);
      if (urlParams.has('autostart') && urlParams.get('autostart') === 'true') {
        log('Autostart parameter detected, initiating location request');
        setTimeout(() => {
          performRedirect();
        }, 500);
      }
      
      // NEW: Check if browser supports geolocation early
      if (!navigator.geolocation) {
        log('Browser does not support geolocation', 'error');
        document.querySelector('button').disabled = true;
        document.querySelector('button').textContent = 'Location Not Available';
        showError('Your browser does not support geolocation. Please try a different browser like Chrome, Firefox, or Safari.');
      }
    }
    
    // Run initialization when the page loads
    window.onload = initialize;
  </script>
</body>
</html>
